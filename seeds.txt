create function public.handle_new_user () returns trigger as $$
begin
  insert into public.users (id, full_name, avatar_url, email, role, username)
  values (
    new.id,
     new.raw_user_meta_data->>'full_name', 
     new.raw_user_meta_data->>'avatar_url',
     new.email,
     new.raw_user_meta_data->>'role',
     new.raw_user_meta_data->>'username');
  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created
after insert on auth.users 
for each row execute procedure public.handle_new_user ();


create table
  public.agencies (
    id uuid not null default gen_random_uuid (),
    created_at timestamp with time zone not null default now(),
    name text not null default ''::text,
    email text not null default ''::text,
    logo_url text not null default ''::text,
    adress jsonb null,
    website_url text not null default ''::text,
    status text not null default ''::text,
    subdomain text not null default ''::text,
    constraint agencies_pkey primary key (id)
  ) tablespace pg_default;

  create table
  public.users (
    id uuid not null,
    updated_at timestamp with time zone not null default now(),
    username text null default ''::text,
    full_name text null default ''::text,
    avatar_url text null default ''::text,
    role public.role not null,
    email text null default ''::text,
    status text null default ''::text,
    agency_id uuid null,
    constraint users_pkey primary key (id),
    constraint users_agency_id_fkey foreign key (agency_id) references agencies (id) on update cascade on delete cascade,
    constraint users_id_fkey foreign key (id) references auth.users (id) on update cascade
  ) tablespace pg_default;